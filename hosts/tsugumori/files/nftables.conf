#!/usr/sbin/nft -f

# Flush existing rules
flush ruleset

# Define tables
table inet filter {

  # Input chain for incoming traffic
  chain input {
    type filter hook input priority 0; policy drop;

    # Accept loopback traffic (localhost)
    iif "lo" accept

    # Allow specific ICMPv6 types (important for IPv6 operation)
    icmpv6 type { nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, nd-redirect } accept

    # Allow incoming ICMP echo-request (ping) with rate limit to prevent DoS
    ip protocol icmp icmp type echo-request limit rate 5/second accept

    # Accept traffic for already established/related connectionu
    ct state { established, related } accept

    tcp dport { 22, 80, 443 } accept
  }

  # Forward chain for forwarded traffic
  chain forward {
    type filter hook forward priority 0; policy accept;

    # Allow forwarding of traffic for already established/related connections
    ct state { established, related } accept

    # Allow forwarding to specific subnet (e.g., VPN or internal network)
    iifname { "tun*", "docker*" } ip daddr 172.18.0.0/16 accept

    # Allow forwarding docker* to eth1
    iifname "docker*" oifname "eth*" accept
  }
}

# NAT Table (for address translation)
table inet nat {
  # Postrouting chain for outgoing traffic (to change source address)
  chain postrouting {
    type nat hook postrouting priority 100; policy accept;
    oifname { "eth*", "tun*" } masquerade
  }
}
